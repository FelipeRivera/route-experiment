{
  "title": "Route Engine â€” SLA & Load",
  "tags": ["route", "experiment", "sla"],
  "timezone": "",
  "schemaVersion": 39,
  "version": 1,
  "refresh": "5s",
  "time": {"from": "now-15m", "to": "now"},
  "templating": {
    "list": [
      {
        "name": "datasource",
        "type": "datasource",
        "label": "Prometheus",
        "query": "prometheus",
        "current": {"text": "Prometheus", "value": "Prometheus"},
        "hide": 0
      },
      {
        "name": "city",
        "type": "query",
        "datasource": {"type": "prometheus", "uid": "${datasource}"},
        "label": "City",
        "query": "label_values(route_requests_total, city)",
        "includeAll": true,
        "allValue": ".*",
        "current": {"text": "All", "value": ".*"},
        "refresh": 2,
        "multi": true
      }
    ]
  },
  "panels": [
    {
      "type": "stat",
      "title": "Requests (last 5m)",
      "gridPos": {"x": 0, "y": 0, "w": 6, "h": 4},
      "targets": [{
        "refId": "A",
        "expr": "sum(increase(route_requests_total{city=~\"$city\"}[5m]))",
        "legendFormat": "",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {
        "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false},
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto"
      },
      "fieldConfig": {"defaults": {"unit": "short", "decimals": 0}, "overrides": []}
    },
    {
      "type": "stat",
      "title": "Degradation ratio (range)",
      "gridPos": {"x": 6, "y": 0, "w": 6, "h": 4},
      "targets": [{
        "refId": "A",
        "expr": "sum(increase(route_requests_total{city=~\"$city\",degraded=\"True\"}[$__range])) / sum(increase(route_requests_total{city=~\"$city\"}[$__range]))",
        "legendFormat": "",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {
        "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false},
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto"
      },
      "fieldConfig": {"defaults": {"unit": "percentunit", "decimals": 2}, "overrides": []}
    },
    {
      "type": "stat",
      "title": "Cache hit rate (range)",
      "gridPos": {"x": 12, "y": 0, "w": 6, "h": 4},
      "targets": [{
        "refId": "A",
        "expr": "sum(increase(route_requests_total{city=~\"$city\",cache_hit=\"true\"}[$__range])) / sum(increase(route_requests_total{city=~\"$city\"}[$__range]))",
        "legendFormat": "",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {
        "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false},
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto"
      },
      "fieldConfig": {"defaults": {"unit": "percentunit", "decimals": 2}, "overrides": []}
    },
    {
      "type": "stat",
      "title": "Failures (last 5m)",
      "gridPos": {"x": 18, "y": 0, "w": 6, "h": 4},
      "targets": [{
        "refId": "A",
        "expr": "sum(increase(route_failures_total[$__range]))",
        "legendFormat": "",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {
        "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false},
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto"
      },
      "fieldConfig": {"defaults": {"unit": "short", "decimals": 0}, "overrides": []}
    },
    {
      "type": "timeseries",
      "title": "RPS (sum)",
      "gridPos": {"x": 0, "y": 4, "w": 12, "h": 8},
      "targets": [{
        "refId": "A",
        "expr": "sum(rate(route_requests_total{city=~\"$city\"}[1m]))",
        "legendFormat": "",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": false}, "tooltip": {"mode": "multi", "sort": "none"}},
      "fieldConfig": {"defaults": {"unit": "reqps"}, "overrides": []}
    },
    {
      "type": "timeseries",
      "title": "P95 latency (s)",
      "gridPos": {"x": 12, "y": 4, "w": 12, "h": 8},
      "targets": [{
        "refId": "A",
        "expr": "histogram_quantile(0.95, sum(rate(route_duration_seconds_bucket{city=~\"$city\"}[5m])) by (le))",
        "legendFormat": "",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
      "fieldConfig": {"defaults": {"unit": "s"}, "overrides": []}
    },
    {
      "type": "timeseries",
      "title": "P99 latency (s)",
      "gridPos": {"x": 0, "y": 12, "w": 12, "h": 8},
      "targets": [{
        "refId": "A",
        "expr": "histogram_quantile(0.99, sum(rate(route_duration_seconds_bucket{city=~\"$city\"}[5m])) by (le))",
        "legendFormat": "",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
      "fieldConfig": {"defaults": {"unit": "s"}, "overrides": []}
    },
    {
      "type": "timeseries",
      "title": "A* Expanded Nodes (P95)",
      "gridPos": {"x": 12, "y": 12, "w": 12, "h": 8},
      "targets": [{
        "refId": "A",
        "expr": "histogram_quantile(0.95, sum(rate(astar_expanded_nodes_bucket[5m])) by (le))",
        "legendFormat": "",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
      "fieldConfig": {"defaults": {"unit": "short"}, "overrides": []}
    },
    {
      "type": "timeseries",
      "title": "RPS by city",
      "gridPos": {"x": 0, "y": 20, "w": 12, "h": 8},
      "targets": [{
        "refId": "A",
        "expr": "sum by (city) (rate(route_requests_total[1m]))",
        "legendFormat": "{{city}}",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
      "fieldConfig": {"defaults": {"unit": "reqps"}, "overrides": []}
    },
    {
      "type": "timeseries",
      "title": "P95 latency by city (s)",
      "gridPos": {"x": 12, "y": 20, "w": 12, "h": 8},
      "targets": [{
        "refId": "A",
        "expr": "histogram_quantile(0.95, sum by (le,city) (rate(route_duration_seconds_bucket[5m])))",
        "legendFormat": "{{city}}",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {"legend": {"displayMode": "list", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "none"}},
      "fieldConfig": {"defaults": {"unit": "s"}, "overrides": []}
    },
    {
      "type": "barchart",
      "title": "Failures by reason (range)",
      "gridPos": {"x": 0, "y": 28, "w": 24, "h": 8},
      "targets": [{
        "refId": "A",
        "expr": "sum by (reason) (increase(route_failures_total[$__range]))",
        "legendFormat": "{{reason}}",
        "datasource": {"type": "prometheus", "uid": "${datasource}"}
      }],
      "options": {"legend": {"displayMode": "list", "placement": "right"}},
      "fieldConfig": {"defaults": {"unit": "short"}, "overrides": []}
    }
  ]
}